<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>For You</title>
    
    <!-- MediaPipe Libraries for AI -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap');

        :root {
            --primary: #ff9a9e;
            --secondary: #fecfef;
            --wood: #8B4513;
            --red: #D32F2F;
            --gold: #FFD700;
        }

        body {
            margin: 0;
            height: 100vh;
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #444;
            transition: background 1s ease;
        }

        /* UTILITIES */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 1s ease forwards; }
        .fade-out { animation: fadeOut 1s ease forwards; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* ================= SCENE 1: INTRO ================= */
        #scene-intro {
            text-align: left;
            width: 80%;
            max-width: 600px;
        }
        .cursor {
            display: inline-block; width: 2px; height: 1.5rem;
            background-color: var(--primary);
            animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }
        
        .soft-btn {
            margin-top: 40px;
            padding: 12px 30px;
            border: 1px solid #ddd;
            border-radius: 50px;
            background: transparent;
            color: #777;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
            opacity: 0; /* Hidden initially */
        }
        .soft-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: white;
        }

        /* ================= SCENE 2: LISTENER ================= */
        #scene-listener {
            text-align: center;
            width: 90%;
            max-width: 500px;
        }
        .card {
            background: rgba(255,255,255,0.9);
            padding: 40px 20px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.05);
        }
        h1 { font-size: 1.8rem; font-weight: 500; }
        .subtext { color: #888; font-size: 0.9rem; margin-top: 10px; }
        
        #countdown { font-size: 4rem; color: var(--primary); margin: 20px 0; }
        
        .next-btn {
            background: var(--primary); color: white; border: none;
            padding: 12px 25px; border-radius: 25px;
            margin-top: 20px; cursor: pointer; font-size: 1rem;
        }

        /* ================= SCENE 3: KAU CIM (STICKS) ================= */
        #scene-fortune {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* The Cylinder Cup */
        .chim-cup {
            width: 120px;
            height: 200px;
            background: linear-gradient(90deg, #6d4c41, #8d6e63, #6d4c41);
            border-radius: 0 0 20px 20px;
            position: relative;
            margin-top: 100px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            z-index: 2;
        }
        
        /* Rim of the cup */
        .chim-cup::before {
            content: ''; position: absolute; top: -15px; left: 0;
            width: 100%; height: 30px;
            background: #5d4037;
            border-radius: 50%;
            border: 2px solid #4e342e;
            z-index: 1;
        }

        /* The Sticks inside */
        .sticks-group {
            position: absolute; top: -40px; left: 20px;
            width: 80px; height: 100px;
            z-index: 0;
        }
        .stick {
            width: 6px; height: 120px;
            background: #d7ccc8;
            border-radius: 3px;
            position: absolute; bottom: 0;
            border: 1px solid #a1887f;
        }
        /* Random positioning for effect */
        .stick:nth-child(1) { left: 10px; transform: rotate(-5deg); height: 130px; background: #e0e0e0; }
        .stick:nth-child(2) { left: 30px; transform: rotate(2deg); height: 125px; }
        .stick:nth-child(3) { left: 50px; transform: rotate(-3deg); height: 135px; }
        .stick:nth-child(4) { left: 20px; transform: rotate(5deg); height: 120px; background: #cfd8dc; }
        .stick:nth-child(5) { left: 45px; transform: rotate(-8deg); height: 128px; }

        /* Animation: Shaking */
        .shaking .chim-cup, .shaking .sticks-group {
            animation: shakeCup 0.2s infinite;
        }

        @keyframes shakeCup {
            0% { transform: rotate(0deg) translate(0, 0); }
            25% { transform: rotate(-5deg) translate(-2px, 2px); }
            50% { transform: rotate(0deg) translate(0, -2px); }
            75% { transform: rotate(5deg) translate(2px, 2px); }
            100% { transform: rotate(0deg) translate(0, 0); }
        }

        /* The Winning Stick (Hidden initially) */
        .winning-stick {
            position: absolute;
            top: 20px; left: 50%; margin-left: -15px;
            width: 30px; height: 200px;
            background: #fff8e1;
            border: 2px solid var(--red);
            z-index: -1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 10px;
            font-weight: bold;
            color: var(--red);
            font-size: 0.8rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(100px);
            transition: all 1s ease;
        }

        /* Animation: Stick Falls Out */
        .stick-reveal {
            opacity: 1;
            transform: translateY(-150px) rotate(10deg);
            z-index: 10;
        }

        /* The Paper Result Modal */
        #fortune-paper {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: 300px;
            background: #fff;
            padding: 30px;
            border: 2px solid var(--red);
            border-radius: 5px;
            text-align: center;
            opacity: 0; pointer-events: none;
            transition: all 0.5s ease;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        #fortune-paper.visible {
            opacity: 1; pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .fortune-title { color: var(--red); font-weight: bold; letter-spacing: 2px; margin-bottom: 15px; }
        .fortune-msg { font-size: 1.2rem; line-height: 1.5; color: #333; }

        .permission-btn {
            margin-top: 150px;
            background: var(--red); color: white;
            padding: 15px 30px; border: none; border-radius: 50px;
            font-size: 1.1rem;
        }

    </style>
</head>
<body>

    <!-- ==================== SCENE 1: INTRO ==================== -->
    <div id="scene-intro">
        <span id="typewriter"></span><span class="cursor"></span>
        <div style="text-align: center;">
            <button class="soft-btn" id="intro-btn" onclick="goToListener()">I'm listening...</button>
        </div>
    </div>

    <!-- ==================== SCENE 2: LISTENER ==================== -->
    <div id="scene-listener" class="hidden">
        <div class="card">
            <h1 id="ai-question">Hey, honestly, are you feeling tired right now?</h1>
            <p class="subtext">(Nod head for Yes, Shake for No)</p>
            <div id="countdown" class="hidden"></div>
            
            <button id="to-fortune-btn" class="next-btn hidden" onclick="goToFortune()">
                I have one last surprise...
            </button>
        </div>
        
        <!-- Hidden Video for AI -->
        <video class="input_video" style="display: none;" playsinline muted></video>
        <div style="margin-top:10px; font-size:0.7rem; color:#ccc;">Camera active for gesture detection</div>
    </div>

    <!-- ==================== SCENE 3: FORTUNE STICKS ==================== -->
    <div id="scene-fortune" class="hidden">
        <h2 style="color: var(--wood);">Ask for a sign...</h2>
        <p style="font-size: 0.9rem; color: #777; margin-bottom: 20px;">Think about your exam, then shake your phone.</p>
        
        <div style="position: relative;">
            <div class="winning-stick" id="winning-stick">
                <span style="writing-mode: vertical-rl;">Good Luck</span>
            </div>

            <div class="chim-cup" id="cup">
                <div class="sticks-group">
                    <div class="stick"></div>
                    <div class="stick"></div>
                    <div class="stick"></div>
                    <div class="stick"></div>
                    <div class="stick"></div>
                </div>
            </div>
        </div>

        <button class="permission-btn" id="perm-btn" onclick="requestMotion()">
            Tap to Enable Shake
        </button>

        <!-- Result Modal -->
        <div id="fortune-paper">
            <div class="fortune-title">UPPER LUCKY SIGN</div>
            <div class="fortune-msg" id="fortune-text">
                Your hard work will pay off.
            </div>
        </div>
    </div>

    <!-- Audio -->
    <audio id="energy-song" src="song.mp3" preload="auto"></audio>

    <script>
        /* ==================== LOGIC: INTRO ==================== */
        const message = "I know things have been heavy lately. You don't always have to be strong. Sometimes, you just need to be heard.";
        const typeSpeed = 50;
        let charIndex = 0;

        function typeWriter() {
            if (charIndex < message.length) {
                document.getElementById('typewriter').innerHTML += message.charAt(charIndex);
                charIndex++;
                setTimeout(typeWriter, typeSpeed);
            } else {
                // Show button after typing
                setTimeout(() => {
                    document.getElementById('intro-btn').style.opacity = '1';
                }, 1000);
            }
        }
        window.onload = typeWriter;

        function goToListener() {
            // Fade out Intro
            document.getElementById('scene-intro').classList.add('fade-out');
            
            setTimeout(() => {
                document.getElementById('scene-intro').classList.add('hidden');
                document.getElementById('scene-listener').classList.remove('hidden');
                document.getElementById('scene-listener').classList.add('fade-in');
                startCameraAI();
            }, 1000);
        }

        /* ==================== LOGIC: LISTENER (AI) ==================== */
        const videoElement = document.getElementsByClassName('input_video')[0];
        const questionText = document.getElementById('ai-question');
        const countdownDisplay = document.getElementById('countdown');
        const audioPlayer = document.getElementById('energy-song');
        
        let interactionDone = false;
        let xBuffer = [], yBuffer = [];
        const bufferSize = 20;

        function startCameraAI() {
            const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
            faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            faceMesh.onResults(onAIResults);

            const camera = new Camera(videoElement, {
                onFrame: async () => { await faceMesh.send({image: videoElement}); },
                width: 640, height: 480
            });
            camera.start();
        }

        function onAIResults(results) {
            if (interactionDone || !results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) return;
            const nose = results.multiFaceLandmarks[0][1];
            detectGesture(nose.x, nose.y);
        }

        function detectGesture(x, y) {
            xBuffer.push(x); yBuffer.push(y);
            if (xBuffer.length > bufferSize) xBuffer.shift();
            if (yBuffer.length > bufferSize) yBuffer.shift();
            if (xBuffer.length < bufferSize) return;

            let xRange = Math.max(...xBuffer) - Math.min(...xBuffer);
            let yRange = Math.max(...yBuffer) - Math.min(...yBuffer);

            // Sensitivity Config
            if (xRange > 0.08 && yRange < 0.03) doShakeAction(); // Shake Head
            else if (yRange > 0.05 && xRange < 0.03) doNodAction(); // Nod Head
        }

        function doNodAction() {
            interactionDone = true;
            questionText.innerHTML = "It's okay. Close your eyes, I'll count for you.";
            document.querySelector('.subtext').style.display = 'none';
            countdownDisplay.classList.remove('hidden');
            
            let count = 10;
            countdownDisplay.innerText = count;
            const timer = setInterval(() => {
                count--;
                countdownDisplay.innerText = count;
                if(count <= 0) {
                    clearInterval(timer);
                    countdownDisplay.style.fontSize = "1.5rem";
                    countdownDisplay.innerText = "You can open your eyes now.";
                    document.getElementById('to-fortune-btn').classList.remove('hidden');
                }
            }, 1000);
        }

        function doShakeAction() {
            interactionDone = true;
            questionText.innerHTML = "That's the spirit! Let's power through!";
            document.querySelector('.subtext').innerText = "Playing your song...";
            
            // Try to play audio (User interacted in Scene 1, so this should work)
            audioPlayer.volume = 0.5;
            audioPlayer.play().catch(e => console.log("Audio block", e));
            
            setTimeout(() => {
                document.getElementById('to-fortune-btn').classList.remove('hidden');
            }, 3000);
        }

        function goToFortune() {
            // Stop Camera to save battery
            const stream = videoElement.srcObject;
            if (stream) stream.getTracks().forEach(track => track.stop());

            document.getElementById('scene-listener').classList.add('fade-out');
            setTimeout(() => {
                document.getElementById('scene-listener').classList.add('hidden');
                document.getElementById('scene-fortune').classList.remove('hidden');
                document.getElementById('scene-fortune').classList.add('fade-in');
                document.body.style.background = "#fff8e1"; // Change BG to warm yellow for luck
            }, 1000);
        }

        /* ==================== LOGIC: FORTUNE (KAU CIM) ==================== */
        const fortunes = [
            "Upper Luck (大吉): Your knowledge is solid. Success is certain.",
            "Medium Luck (中吉): Stay calm. The answer will come to you.",
            "Great Luck (上上): The stars are aligned for your exam!",
            "Luck (吉): Trust your first instinct. It is usually right.",
            "Blessing: Your hard work has created its own luck."
        ];

        let motionAllowed = false;
        let lastUpdate = 0, lastX=0, lastY=0, lastZ=0;
        let isShaking = false;
        let revealed = false;

        function requestMotion() {
            // iOS 13+ Permission Check
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(state => {
                        if (state === 'granted') enableShake();
                        else alert("I need permission to feel the shake!");
                    })
                    .catch(console.error);
            } else {
                enableShake();
            }
        }

        function enableShake() {
            motionAllowed = true;
            document.getElementById('perm-btn').style.display = 'none';
            window.addEventListener('devicemotion', handleMotion);
        }

        function handleMotion(e) {
            if(revealed) return;

            let acc = e.accelerationIncludingGravity;
            let curTime = new Date().getTime();

            if ((curTime - lastUpdate) > 100) {
                let diffTime = curTime - lastUpdate;
                lastUpdate = curTime;
                
                let speed = Math.abs(acc.x + acc.y + acc.z - lastX - lastY - lastZ) / diffTime * 10000;

                if (speed > 300) {
                    // Visual Shake
                    document.getElementById('cup').classList.add('shaking');
                    if(navigator.vibrate) navigator.vibrate(50);
                } else {
                    document.getElementById('cup').classList.remove('shaking');
                }

                // Threshold to release stick
                if (speed > 2000) { 
                    revealStick();
                }

                lastX = acc.x; lastY = acc.y; lastZ = acc.z;
            }
        }

        function revealStick() {
            revealed = true;
            window.removeEventListener('devicemotion', handleMotion);
            document.getElementById('cup').classList.remove('shaking');
            
            // 1. Animate Stick
            const stick = document.getElementById('winning-stick');
            stick.classList.add('stick-reveal');
            if(navigator.vibrate) navigator.vibrate([100, 50, 100]);

            // 2. Select Fortune
            const msg = fortunes[Math.floor(Math.random() * fortunes.length)];
            document.getElementById('fortune-text').innerText = msg;

            // 3. Show Paper Modal
            setTimeout(() => {
                document.getElementById('fortune-paper').classList.add('visible');
            }, 1500);
        }
    </script>
</body>
</html>
